<!DOCTYPE html>
<html lang="pt-CV">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Forças Armadas de Cabo Verde - Sistema de Gerenciamento de Missões</title>
    
    <!-- BIBLIOTECAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-dark: #0a2e5c;
            --primary: #1e4a8f;
            --primary-light: #2d6cbf;
            --secondary: #e6a50f;
            --secondary-dark: #c58a0c;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        body.dark-mode {
            --primary-dark: #0a1a2c;
            --primary: #0e2a4a;
            --light: #1a1e24;
            --dark: #f8f9fa;
            --gray: #adb5bd;
            --gray-light: #2d3238;
            background-color: #121212;
            color: #e0e0e0;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(rgba(10, 46, 92, 0.9), rgba(10, 46, 92, 0.95)), url('https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?ixlib=rb-4.0.3&auto=format&fit=crop&w=1794&q=80') no-repeat center center/cover;
        }
        
        .login-box {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            text-align: center;
        }
        
        .login-logo {
            margin-bottom: 25px;
        }
        
        .login-logo h1 {
            color: var(--primary-dark);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .logo-symbol {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background-color: var(--primary-dark);
            color: white;
            border-radius: 50%;
            font-size: 2rem;
            margin-bottom: 15px;
            border: 3px solid var(--secondary);
            overflow: hidden;
        }
        
        .logo-symbol img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .login-form input, .login-form select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .login-form input:focus, .login-form select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 74, 143, 0.2);
        }
        
        .btn-login {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .btn-login:hover {
            background-color: var(--primary-dark);
        }
        
        .login-footer {
            margin-top: 25px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Main Application */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .dark-mode .header {
            background-color: #1e1e1e;
            color: white;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-logo .logo-symbol {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }
        
        .header-logo h1 {
            font-size: 1.5rem;
            color: var(--primary-dark);
        }
        
        .dark-mode .header-logo h1 {
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-details {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .dark-mode .user-name {
            color: white;
        }
        
        .user-rank {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .btn-logout {
            padding: 8px 15px;
            background-color: var(--gray-light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-logout:hover {
            background-color: #ddd;
        }
        
        /* Navigation */
        .nav {
            background-color: var(--primary-dark);
        }
        
        .nav-list {
            display: flex;
            list-style: none;
            padding: 0 30px;
        }
        
        .nav-item {
            padding: 15px 20px;
            position: relative;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--secondary);
        }
        
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            padding: 30px;
        }
        
        /* Views */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .dark-mode .stat-card {
            background-color: #2d2d2d;
            color: white;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .icon-total { background-color: var(--primary); }
        .icon-completed { background-color: var(--success); }
        .icon-progress { background-color: var(--warning); }
        .icon-pending { background-color: var(--danger); }
        
        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .dark-mode .stat-info h3 {
            color: white;
        }
        
        .stat-info p {
            color: var(--gray);
        }
        
        /* Sections */
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .section {
            background-color: #2d2d2d;
            color: white;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .section-title {
            font-size: 1.5rem;
            color: var(--primary-dark);
        }
        
        .dark-mode .section-title {
            color: white;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--gray);
        }
        
        .btn-outline:hover {
            background: var(--gray-light);
        }
        
        /* Task List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--gray-light);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dark-mode .task-item {
            background-color: #3d3d3d;
            color: white;
        }
        
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .task-info h4 {
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .dark-mode .task-info h4 {
            color: white;
        }
        
        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .task-priority {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .priority-low { background-color: #e8f5e9; color: #2e7d32; }
        .priority-medium { background-color: #fff3e0; color: #f57c00; }
        .priority-high { background-color: #ffebee; color: #c62828; }
        .priority-urgent { background-color: #fce4ec; color: #ad1457; }
        
        .task-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-not-started { background-color: #e0e0e0; color: #616161; }
        .status-in-progress { background-color: #e3f2fd; color: #1565c0; }
        .status-completed { background-color: #e8f5e9; color: #2e7d32; }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .kanban-column {
            background-color: var(--gray-light);
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
        }
        
        .dark-mode .kanban-column {
            background-color: #3d3d3d;
        }
        
        .kanban-column h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
            color: var(--primary-dark);
        }
        
        .dark-mode .kanban-column h3 {
            color: white;
        }
        
        .column-not-started h3 { border-color: #616161; }
        .column-in-progress h3 { border-color: #1565c0; }
        .column-completed h3 { border-color: #2e7d32; }
        
        .kanban-task {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: move;
        }
        
        .dark-mode .kanban-task {
            background-color: #4d4d4d;
            color: white;
        }
        
        .kanban-task h4 {
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .dark-mode .kanban-task h4 {
            color: white;
        }
        
        /* Comments Section */
        .comments-section {
            margin-top: 30px;
        }
        
        .comments-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }
        
        .comment-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .dark-mode .comment-item {
            background-color: #3d3d3d;
            color: white;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .dark-mode .comment-author {
            color: white;
        }
        
        .comment-time {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .comment-content {
            color: var(--dark);
        }
        
        .dark-mode .comment-content {
            color: #e0e0e0;
        }
        
        .comment-form {
            display: flex;
            gap: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .comment-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .dark-mode .comment-input {
            background-color: #3d3d3d;
            color: white;
            border-color: #555;
        }
        
        /* Calendar */
        .calendar {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .calendar {
            background-color: #2d2d2d;
            color: white;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: var(--primary);
            color: white;
        }
        
        .calendar-nav button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 15px;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary-light);
            color: white;
            font-weight: 600;
        }
        
        .calendar-weekday {
            padding: 15px;
            text-align: center;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .calendar-day {
            padding: 15px;
            border: 1px solid var(--gray-light);
            min-height: 100px;
            position: relative;
        }
        
        .dark-mode .calendar-day {
            border-color: #555;
        }
        
        .day-number {
            position: absolute;
            top: 10px;
            right: 10px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .dark-mode .day-number {
            color: white;
        }
        
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: var(--gray);
        }
        
        .dark-mode .calendar-day.other-month {
            background-color: #222;
            color: #888;
        }
        
        .calendar-day.today {
            background-color: rgba(30, 74, 143, 0.1);
        }
        
        .dark-mode .calendar-day.today {
            background-color: rgba(230, 165, 15, 0.2);
        }
        
        .calendar-events {
            margin-top: 25px;
            max-height: 70px;
            overflow-y: auto;
        }
        
        .calendar-event {
            font-size: 0.75rem;
            padding: 3px 6px;
            margin-bottom: 3px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .event-high { background-color: #ffebee; color: #c62828; }
        .event-medium { background-color: #fff3e0; color: #f57c00; }
        .event-low { background-color: #e8f5e9; color: #2e7d32; }
        .event-urgent { background-color: #fce4ec; color: #ad1457; }
        
        .dark-mode .event-high { background-color: #7f1d1d; color: #ffcdd2; }
        .dark-mode .event-medium { background-color: #7f5c1d; color: #fff3e0; }
        .dark-mode .event-low { background-color: #1d3f1d; color: #e8f5e9; }
        .dark-mode .event-urgent { background-color: #7f1d4d; color: #fce4ec; }
        
        /* Forms */
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .dark-mode .modal-content {
            background-color: #2d2d2d;
            color: white;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-dark);
        }
        
        .dark-mode .modal-title {
            color: white;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .dark-mode .form-group label {
            color: white;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .dark-mode .form-group input,
        .dark-mode .form-group select,
        .dark-mode .form-group textarea {
            background-color: #3d3d3d;
            color: white;
            border-color: #555;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* User DB Info */
        .user-db-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .dark-mode .user-db-info {
            background-color: #1e3a5f;
            color: white;
        }
        
        .user-db-info h4 {
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dark-mode .user-db-info h4 {
            color: white;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--gray-light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }
        
        /* Subtask */
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .subtask-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .subtask-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Notification Modal */
        .notification-modal {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .dark-mode .notification-modal {
            background-color: #2d2d2d;
            color: white;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: var(--gray-light);
        }
        
        .notification-item.unread {
            background-color: rgba(30, 74, 143, 0.1);
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 8px;
        }
        
        .filter-item {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 150px;
        }
        
        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .confirm-content {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .dark-mode .confirm-content {
            background-color: #2d2d2d;
            color: white;
        }
        
        .confirm-icon {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 15px;
        }
        
        .confirm-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }
        
        .dark-mode .confirm-title {
            color: white;
        }
        
        .confirm-message {
            margin-bottom: 20px;
            color: var(--gray);
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .confirm-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .confirm-btn-yes {
            background-color: var(--danger);
            color: white;
        }
        
        .confirm-btn-yes:hover {
            background-color: #b71c1c;
        }
        
        .confirm-btn-no {
            background-color: var(--gray-light);
            color: var(--dark);
        }
        
        .confirm-btn-no:hover {
            background-color: var(--gray);
            color: white;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .nav-list {
                flex-direction: column;
                padding: 0;
            }
            
            .nav-item {
                padding: 12px 30px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .comment-form {
                flex-direction: column;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .filter-item {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .user-details {
                text-align: center;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .task-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .task-actions {
                align-self: flex-end;
            }
            
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .calendar-days .calendar-day {
                min-height: 80px;
                padding: 10px 5px;
            }
            
            .calendar-event {
                font-size: 0.7rem;
                padding: 2px 4px;
            }
        }
        
        @media (max-width: 576px) {
            .login-box {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-question-circle"></i>
            </div>
            <h3 class="confirm-title" id="confirmTitle">Confirmar Saída</h3>
            <p class="confirm-message" id="confirmMessage">Tem certeza que deseja sair do sistema? Todos os dados já foram salvos automaticamente.</p>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-yes" id="confirmYes">
                    <i class="fas fa-check"></i> Sim, Sair
                </button>
                <button class="confirm-btn confirm-btn-no" id="confirmNo">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo-symbol">
                    <img src="img/Brasão das FA 4-4.png" width="70" height="70" alt="Logotipo Forças Armadas" onerror="this.src='https://via.placeholder.com/70?text=FACV'">
                </div>
                <h1>Forças Armadas de Cabo Verde</h1>
                <p>Sistema de Gerenciamento de Missões</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="fullName"><i class="fas fa-user"></i> Nome Completo</label>
                    <input type="text" id="fullName" placeholder="Ex: Tenente João Silva" required>
                </div>
                
                <div class="form-group">
                    <label for="militaryRank"><i class="fas fa-tag"></i> Posto/Função Militar</label>
                    <select id="militaryRank" required>
                        <option value="">Selecione o posto/função</option>
                        <option value="Soldado">Soldado</option>
                        <option value="Cabo">Cabo</option>
                        <option value="Sargento">Sargento</option>
                        <option value="Tenente">Tenente</option>
                        <option value="Primeiro-Tenente">Primeiro-Tenente</option>
                        <option value="Capitão">Capitão</option>
                        <option value="Major">Major</option>
                        <option value="Coronel">Coronel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="userId"><i class="fas fa-id-card"></i> ID de Utilizador (CIRP)</label>
                    <input type="text" id="userId" placeholder="Ex: CIRP2026" value="CIRP2026" required>
                    <small style="color: var(--gray);">CIRP padrão: CIRP2026</small>
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="password" placeholder="••••••••" value="123456" required>
                </div>
                
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Acessar Sistema
                </button>
            </form>
            
            <div class="login-footer">
                <p>Acesso restrito ao pessoal autorizado das Forças Armadas de Cabo Verde</p>
                <p style="margin-top: 10px; font-size: 0.8rem;">Cada utilizador possui banco de dados isolado</p>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-logo">
                    <div class="logo-symbol">
                        <img src="img/Brasão das FA 4-4.png" width="50" height="50" alt="Logotipo Forças Armadas" onerror="this.src='https://via.placeholder.com/50?text=FACV'">
                    </div>
                    <h1>FACV - Sistema de Missões</h1>
                </div>
                
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name" id="loggedUserName">Carregando...</div>
                        <div class="user-rank" id="loggedUserRank">-</div>
                        <div class="user-id" id="loggedUserId" style="font-size: 0.8rem; color: var(--gray);">ID: -</div>
                    </div>
                    <button class="btn btn-outline" id="darkModeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn-logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Home
                        <span class="notification-badge" id="dashboardNotification" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="missions">
                        <i class="fas fa-tasks"></i> Missões
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="reports">
                        <i class="fas fa-flag"></i> Relatórios
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="calendar">
                        <i class="fas fa-calendar-alt"></i> Calendário
                    </a>
                </li>
                <li class="nav-item notification-badge">
                    <a href="#" class="nav-link" id="notificationBell">
                        <i class="fas fa-bell"></i> Alertas
                        <span class="notification-badge" id="notificationCount">0</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <!-- Notifications Panel -->
        <div class="notification-modal" id="notificationPanel">
            <div style="padding: 15px; border-bottom: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0;">Notificações</h4>
                <button class="btn btn-outline" style="padding: 5px 10px;" onclick="markAllNotificationsRead()">
                    <i class="fas fa-check-double"></i>
                </button>
            </div>
            <div id="notificationsList" style="max-height: 350px; overflow-y: auto;">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboardSection">
                <div class="user-db-info">
                    <h4><i class="fas fa-database"></i> Mensagem do Comando</h4>
                    <p>Desejamos a todos uma excelente organização dos trabalhos, pautada pela disciplina, pelo espírito de cooperação e pelo elevado sentido de responsabilidade. Que a execução das missões atribuídas decorra com eficiência, rigor e profissionalismo, garantindo o cumprimento dos objetivos estabelecidos e o sucesso das atividades planeadas.</p>
                    <p>Que o empenho, a dedicação e a coesão de todos sejam fatores determinantes para o bom desempenho das tarefas, contribuindo para resultados positivos e para o fortalecimento da missão institucional.</p>
                    <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 0.9rem; flex-wrap: wrap;">
                        <div><strong>ID do Banco:</strong> <span id="dbIdDisplay">-</span></div>
                        <div><strong>Utilizador:</strong> <span id="dbUserDisplay">-</span></div>
                        <div><strong>Missões:</strong> <span id="dbTasksCount">0</span></div>
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon icon-total">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalTasks">0</h3>
                            <p>Total de Missões</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="completedTasks">0</h3>
                            <p>Missões Concluídas</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-progress">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="inProgressTasks">0</h3>
                            <p>Missões em Andamento</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pendingTasks">0</h3>
                            <p>Missões Pendentes</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <h3 class="section-title" style="margin-bottom: 15px;">Progresso Geral</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="overallProgress" style="width: 0%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span>Progresso: <strong id="progressPercentage">0%</strong></span>
                            <span>Meta Mensal: <strong id="monthlyGoal">0/0</strong></span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title" style="margin-bottom: 15px;">Produtividade</h3>
                        <div class="chart-container">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Missões Recentes</h2>
                        <div>
                            <button class="btn btn-primary" onclick="openMissionModal()">
                                <i class="fas fa-plus"></i> Nova Missão
                            </button>
                        </div>
                    </div>
                    
                    <div class="task-list" id="recentTasksList">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>
            </section>
            
            <!-- Missions Section -->
            <section class="content-section" id="missionsSection">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Quadro de Missões</h2>
                        <div>
                            <button class="btn btn-primary" onclick="openMissionModal()">
                                <i class="fas fa-plus"></i> Nova Missão
                            </button>
                            <button class="btn btn-outline" onclick="exportUserData()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filter-bar">
                        <select id="filterPriority" class="filter-item">
                            <option value="">Todas Prioridades</option>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                        
                        <select id="filterStatus" class="filter-item">
                            <option value="">Todos Status</option>
                            <option value="not-started">Não Iniciada</option>
                            <option value="in-progress">Em Andamento</option>
                            <option value="completed">Concluída</option>
                        </select>
                        
                        <input type="date" id="filterDate" class="filter-item">
                        
                        <button class="btn btn-outline" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        
                        <button class="btn btn-outline" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                    
                    <div class="kanban-board" id="kanbanBoard">
                        <div class="kanban-column column-not-started">
                            <h3><i class="fas fa-hourglass-start"></i> Não Iniciadas</h3>
                            <div class="kanban-column-content" data-status="not-started"></div>
                        </div>
                        
                        <div class="kanban-column column-in-progress">
                            <h3><i class="fas fa-spinner"></i> Em Andamento</h3>
                            <div class="kanban-column-content" data-status="in-progress"></div>
                        </div>
                        
                        <div class="kanban-column column-completed">
                            <h3><i class="fas fa-check-circle"></i> Concluídas</h3>
                            <div class="kanban-column-content" data-status="completed"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Reports Section -->
            <section class="content-section" id="reportsSection">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Relatórios das Missões</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <h3 style="margin-bottom: 15px;">Exportar Relatórios</h3>
                            <div style="display: grid; gap: 15px;">
                                <select id="reportProject" class="filter-item">
                                    <option value="">Todos os Projetos</option>
                                </select>
                                <div style="display: flex; gap: 10px;">
                                    <input type="date" id="reportStartDate" class="filter-item" placeholder="Data Início">
                                    <input type="date" id="reportEndDate" class="filter-item" placeholder="Data Fim">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" style="flex: 1;" onclick="generatePDF()">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                    <button class="btn btn-success" style="flex: 1;" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel"></i> Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 15px;">Backup de Dados</h3>
                            <div style="background: var(--gray-light); padding: 15px; border-radius: 8px;">
                                <p><i class="fas fa-clock"></i> Último backup: <span id="lastBackup">Nunca</span></p>
                                <p><i class="fas fa-database"></i> Missões: <span id="backupTasksCount">0</span></p>
                                <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="manualBackup()">
                                    <i class="fas fa-database"></i> Fazer Backup
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comments-section">
                        <h3 style="margin-bottom: 20px; color: var(--primary-dark);">Comentários em Tempo Real</h3>
                        
                        <div class="comments-list" id="commentsList">
                            <!-- Comments will be loaded here dynamically -->
                        </div>
                        
                        <form class="comment-form" id="commentForm">
                            <input type="text" class="comment-input" id="commentInput" placeholder="Digite seu comentário sobre as missões..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </form>
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-dark);">Estatísticas de Execução</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background-color: var(--gray-light); padding: 20px; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary-dark);">Progresso por Responsável</h4>
                                <div id="progressByResponsible"></div>
                            </div>
                            <div style="background-color: var(--gray-light); padding: 20px; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary-dark);">Missões por Prioridade</h4>
                                <div id="tasksByPriority"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Calendar Section -->
            <section class="content-section" id="calendarSection">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Calendário de Agendamento de Missões</h2>
                        <button class="btn btn-primary" onclick="openMissionModal()">
                            <i class="fas fa-plus"></i> Nova Missão
                        </button>
                    </div>
                    
                    <div class="calendar">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="prevMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="currentMonth">Fevereiro 2026</h3>
                            <button class="calendar-nav" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">Dom</div>
                            <div class="calendar-weekday">Seg</div>
                            <div class="calendar-weekday">Ter</div>
                            <div class="calendar-weekday">Qua</div>
                            <div class="calendar-weekday">Qui</div>
                            <div class="calendar-weekday">Sex</div>
                            <div class="calendar-weekday">Sáb</div>
                        </div>
                        
                        <div class="calendar-days" id="calendarDays"></div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-dark);">Legenda</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 15px; height: 15px; background-color: #ffebee; border-radius: 3px;"></div>
                                <span>Prioridade Alta</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 15px; height: 15px; background-color: #fff3e0; border-radius: 3px;"></div>
                                <span>Prioridade Média</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 15px; height: 15px; background-color: #e8f5e9; border-radius: 3px;"></div>
                                <span>Prioridade Baixa</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 15px; height: 15px; background-color: #fce4ec; border-radius: 3px;"></div>
                                <span>Prioridade Urgente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Task Form Modal -->
    <div class="form-modal" id="taskFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Missão/Tarefa</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="taskForm" onsubmit="saveMission(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskTitle">Título da Missão *</label>
                        <input type="text" id="taskTitle" placeholder="Ex: Patrulha de segurança na zona norte" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Prioridade *</label>
                        <select id="taskPriority" required>
                            <option value="">Selecione a prioridade</option>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="taskDescription">Descrição da Missão *</label>
                    <textarea id="taskDescription" placeholder="Descreva detalhadamente a missão a ser realizada..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskDeadline">Prazo *</label>
                        <input type="date" id="taskDeadline" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskResponsible">Responsável *</label>
                        <select id="taskResponsible" required>
                            <option value="">Selecione o responsável</option>
                            <option value="Capitão Lavinio Lopes">CIRP</option>
                            <option value="Comando FACV">Comando FACV</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="taskStatus">Status *</label>
                    <select id="taskStatus" required>
                        <option value="not-started">Não Iniciada</option>
                        <option value="in-progress">Em Andamento</option>
                        <option value="completed">Concluída</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskProgress">Progresso (%)</label>
                    <input type="range" id="taskProgress" min="0" max="100" value="0" oninput="updateProgressValue(this.value)">
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>0%</span>
                        <span id="progressValue">0%</span>
                        <span>100%</span>
                    </div>
                </div>
                
                <div id="subtasksContainer" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                        <i class="fas fa-tasks"></i> Subtarefas (Progresso automático)
                    </label>
                    <div id="subtasksList"></div>
                    <button type="button" class="btn btn-outline" style="margin-top: 10px;" onclick="addSubtaskField()">
                        <i class="fas fa-plus"></i> Adicionar Subtarefa
                    </button>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Missão</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let currentUser = null;
        let currentUserId = null;
        let tasks = [];
        let comments = [];
        let notifications = [];
        let subtasks = {};
        let editingTaskId = null;
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let chartInstance = null;
        let logoutTimer;
        let subtaskCounter = 0;
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const loggedUserName = document.getElementById('loggedUserName');
        const loggedUserRank = document.getElementById('loggedUserRank');
        const loggedUserId = document.getElementById('loggedUserId');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const taskFormModal = document.getElementById('taskFormModal');
        const commentForm = document.getElementById('commentForm');
        const commentInput = document.getElementById('commentInput');
        const commentsList = document.getElementById('commentsList');
        const calendarDays = document.getElementById('calendarDays');
        const currentMonthElement = document.getElementById('currentMonth');
        const dbIdDisplay = document.getElementById('dbIdDisplay');
        const dbUserDisplay = document.getElementById('dbUserDisplay');
        const dbTasksCount = document.getElementById('dbTasksCount');
        const notificationBell = document.getElementById('notificationBell');
        const notificationPanel = document.getElementById('notificationPanel');
        const notificationCount = document.getElementById('notificationCount');
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // ============================================
        // CONFIRMATION DIALOG
        // ============================================
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        
        let pendingAction = null;
        
        function showConfirmDialog(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmDialog.style.display = 'flex';
            pendingAction = onConfirm;
        }
        
        function hideConfirmDialog() {
            confirmDialog.style.display = 'none';
            pendingAction = null;
        }
        
        confirmYes.addEventListener('click', function() {
            if (pendingAction) {
                pendingAction();
            }
            hideConfirmDialog();
        });
        
        confirmNo.addEventListener('click', function() {
            hideConfirmDialog();
        });
        
        // Fechar ao clicar fora
        confirmDialog.addEventListener('click', function(e) {
            if (e.target === confirmDialog) {
                hideConfirmDialog();
            }
        });
        
        // ============================================
        // SALVAMENTO AUTOMÁTICO E SEGURO
        // ============================================
        function saveAllData() {
            if (!currentUserId) return;
            
            const userDb = new UserDatabase(currentUserId);
            
            // Salvar todos os dados
            userDb.saveTasks(tasks);
            userDb.saveComments(comments);
            userDb.saveSubtasks(subtasks);
            userDb.saveNotifications(notifications);
            
            // Atualizar timestamps
            const settings = userDb.loadUserSettings();
            settings.lastSave = new Date().toISOString();
            userDb.saveUserSettings(settings);
            
            // Atualizar contadores
            if (dbTasksCount) dbTasksCount.textContent = tasks.length;
            if (document.getElementById('backupTasksCount')) {
                document.getElementById('backupTasksCount').textContent = tasks.length;
            }
            
            return true;
        }
        
        // ============================================
        // CLASSE USER DATABASE
        // ============================================
        class UserDatabase {
            constructor(userId) {
                this.userId = userId;
                this.storagePrefix = `facv_user_${userId}_`;
            }
            
            saveTasks(tasksArray) {
                localStorage.setItem(this.storagePrefix + 'tasks', JSON.stringify(tasksArray));
            }
            
            loadTasks() {
                const tasksData = localStorage.getItem(this.storagePrefix + 'tasks');
                return tasksData ? JSON.parse(tasksData) : [];
            }
            
            saveComments(commentsArray) {
                localStorage.setItem(this.storagePrefix + 'comments', JSON.stringify(commentsArray));
            }
            
            loadComments() {
                const commentsData = localStorage.getItem(this.storagePrefix + 'comments');
                return commentsData ? JSON.parse(commentsData) : [];
            }
            
            saveSubtasks(subtasksObject) {
                localStorage.setItem(this.storagePrefix + 'subtasks', JSON.stringify(subtasksObject));
            }
            
            loadSubtasks() {
                const subtasksData = localStorage.getItem(this.storagePrefix + 'subtasks');
                return subtasksData ? JSON.parse(subtasksData) : {};
            }
            
            saveNotifications(notificationsArray) {
                localStorage.setItem(this.storagePrefix + 'notifications', JSON.stringify(notificationsArray));
            }
            
            loadNotifications() {
                const notificationsData = localStorage.getItem(this.storagePrefix + 'notifications');
                return notificationsData ? JSON.parse(notificationsData) : [];
            }
            
            saveUserSettings(settings) {
                localStorage.setItem(this.storagePrefix + 'settings', JSON.stringify(settings));
            }
            
            loadUserSettings() {
                const settingsData = localStorage.getItem(this.storagePrefix + 'settings');
                return settingsData ? JSON.parse(settingsData) : {};
            }
            
            getAllData() {
                return {
                    userId: this.userId,
                    tasks: this.loadTasks(),
                    comments: this.loadComments(),
                    subtasks: this.loadSubtasks(),
                    notifications: this.loadNotifications(),
                    settings: this.loadUserSettings(),
                    exportDate: new Date().toISOString()
                };
            }
            
            static userExists(userId) {
                return localStorage.getItem(`facv_user_${userId}_tasks`) !== null;
            }
        }
        
        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar modo escuro salvo
            const savedDarkMode = localStorage.getItem('facv_dark_mode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                if (darkModeToggle) {
                    const icon = darkModeToggle.querySelector('i');
                    if (icon) icon.className = 'fas fa-sun';
                }
            }
            
            // Verificar se já está logado
            const savedUser = localStorage.getItem('facv_current_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    currentUser = userData;
                    currentUserId = userData.userId;
                    loadUserDatabase();
                    showApp();
                } catch (e) {
                    console.error('Erro ao carregar usuário:', e);
                }
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Solicitar permissão para notificações
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Setup sincronização entre abas
            window.addEventListener('storage', function(e) {
                if (e.key && e.key.includes('facv_user_')) {
                    loadUserDatabase();
                    updateUI();
                }
            });
            
            // Salvamento automático a cada 30 segundos
            setInterval(() => {
                if (currentUser) {
                    saveAllData();
                }
            }, 30000);
            
            // Salvar dados antes de fechar/recarregar a página
            window.addEventListener('beforeunload', function(e) {
                if (currentUser) {
                    saveAllData();
                }
            });
        });
        
        // ============================================
        // SETUP EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fullName = document.getElementById('fullName').value.trim();
                const militaryRank = document.getElementById('militaryRank').value;
                const userId = document.getElementById('userId').value.trim();
                const password = document.getElementById('password').value;
                
                if (!fullName || !militaryRank || !userId) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                
                // Validar CIRP
                if (userId !== 'CIRP2026') {
                    alert('CIRP inválido! Utilize CIRP2026');
                    return;
                }
                
                // Validar ID alfanumérico
                if (!/^[a-zA-Z0-9]+$/.test(userId)) {
                    alert('O ID deve conter apenas letras e números.');
                    return;
                }
                
                // Criar usuário
                currentUser = {
                    fullName: fullName,
                    rank: militaryRank,
                    userId: userId,
                    loginTime: new Date().toISOString()
                };
                
                currentUserId = userId;
                
                // Inicializar banco de dados
                loadUserDatabase();
                
                // Salvar sessão
                localStorage.setItem('facv_current_user', JSON.stringify(currentUser));
                
                // Dados iniciais para novos usuários
                if (!UserDatabase.userExists(userId)) {
                    initializeSampleData();
                    const userDb = new UserDatabase(userId);
                    userDb.saveUserSettings({
                        fullName: fullName,
                        rank: militaryRank,
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    });
                }
                
                // Adicionar notificação
                addNotification(`✅ ${fullName} (${militaryRank}) acessou o sistema.`);
                
                showApp();
                
                // Iniciar timer de inatividade
                startInactivityTimer();
            });
            
            // Logout com confirmação e salvamento automático
            logoutBtn.addEventListener('click', function() {
                showConfirmDialog(
                    'Confirmar Saída',
                    'Tem certeza que deseja sair do sistema? Todos os dados já foram salvos automaticamente.',
                    function() {
                        // Salvar dados antes de sair
                        saveAllData();
                        
                        // Registrar saída
                        if (currentUser) {
                            addNotification(`👋 ${currentUser.fullName} saiu do sistema.`);
                            
                            const userDb = new UserDatabase(currentUserId);
                            const settings = userDb.loadUserSettings();
                            settings.lastLogout = new Date().toISOString();
                            userDb.saveUserSettings(settings);
                        }
                        
                        // Limpar sessão
                        currentUser = null;
                        currentUserId = null;
                        localStorage.removeItem('facv_current_user');
                        
                        // Voltar para login
                        loginPage.style.display = 'flex';
                        appContainer.style.display = 'none';
                        loginForm.reset();
                        
                        if (logoutTimer) clearTimeout(logoutTimer);
                    }
                );
            });
            
            // Navigation - FUNCIONALIDADE PRINCIPAL DA NAVBAR
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Salvar dados antes de mudar de seção
                    saveAllData();
                    
                    // Remover active de todos os links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Adicionar active ao link clicado
                    this.classList.add('active');
                    
                    // Obter a seção alvo
                    const sectionId = this.getAttribute('data-section') + 'Section';
                    
                    // Ocultar todas as seções
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Mostrar a seção selecionada
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                        
                        // Atualizar conteúdo da seção
                        if (sectionId === 'dashboardSection') {
                            updateDashboardStats();
                            loadRecentTasks();
                        } else if (sectionId === 'missionsSection') {
                            loadKanbanBoard();
                        } else if (sectionId === 'reportsSection') {
                            loadComments();
                            updateReportsStats();
                        } else if (sectionId === 'calendarSection') {
                            generateCalendar(currentMonth, currentYear);
                        }
                    }
                });
            });
            
            // Comment form
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const content = commentInput.value.trim();
                if (content) {
                    addComment(content, null);
                    commentInput.value = '';
                    saveAllData(); // Salvar imediatamente
                }
            });
            
            // Notification bell
            notificationBell.addEventListener('click', function(e) {
                e.preventDefault();
                toggleNotificationPanel();
            });
            
            // Dark mode toggle
            darkModeToggle.addEventListener('click', function() {
                toggleDarkMode();
                saveAllData(); // Salvar preferência
            });
            
            // Click outside notification panel
            document.addEventListener('click', function(e) {
                if (!notificationPanel.contains(e.target) && !notificationBell.contains(e.target)) {
                    notificationPanel.style.display = 'none';
                }
                
                if (e.target === taskFormModal) {
                    closeModal();
                }
            });
            
            // Inactivity timer
            ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });
        }
        
        // ============================================
        // LOGOUT E INATIVIDADE
        // ============================================
        function logout() {
            // Este método agora é chamado pelo confirm dialog
            // O logout real é feito no callback do confirm dialog
        }
        
        function startInactivityTimer() {
            if (logoutTimer) clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                if (currentUser) {
                    showConfirmDialog(
                        'Sessão Expirou',
                        'Você ficou inativo por 15 minutos. Deseja permanecer logado?',
                        function() {
                            // Usuário quer continuar
                            startInactivityTimer();
                            addNotification('⏰ Sessão estendida');
                        }
                    );
                }
            }, 15 * 60 * 1000); // 15 minutos
        }

        function resetInactivityTimer() {
            if (currentUser) {
                startInactivityTimer();
            }
        }
        
        // ============================================
        // LOAD USER DATABASE
        // ============================================
        function loadUserDatabase() {
            if (!currentUserId) return;
            
            const userDb = new UserDatabase(currentUserId);
            
            tasks = userDb.loadTasks();
            comments = userDb.loadComments();
            subtasks = userDb.loadSubtasks();
            notifications = userDb.loadNotifications();
            
            if (tasks.length === 0) {
                initializeSampleData();
            }
            
            updateUI();
        }
        
        // ============================================
        // INITIALIZE SAMPLE DATA
        // ============================================
        function initializeSampleData() {
            const now = Date.now();
            
            const sampleTasks = [
                {
                    id: now + 1,
                    title: "Banner VII Edição Corrida das Forças Armadas",
                    description: "Desenvolvimento do Banner da Corrida das Forças Armadas - Edição 2026",
                    priority: "high",
                    deadline: getDateString(5),
                    responsible: "CIRP",
                    status: "in-progress",
                    progress: 40,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: currentUserId
                },
                {
                    id: now + 2,
                    title: "Reunião Conselho Superior de Comando",
                    description: "Reunião alargada a Diretores e serviços - Dias 12 e 13 de março",
                    priority: "medium",
                    deadline: getDateString(3),
                    responsible: "CIRP e Comandos FACV",
                    status: "not-started",
                    progress: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: currentUserId
                },
                {
                    id: now + 3,
                    title: "Feira de Saúde - Plateau",
                    description: "59º aniversário das Forças Armadas - Consultas médicas e cuidados de enfermagem",
                    priority: "medium",
                    deadline: getDateString(-2),
                    responsible: "CIRP",
                    status: "completed",
                    progress: 100,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: currentUserId
                }
            ];
            
            tasks = sampleTasks;
            saveAllData();
            
            // Subtarefas de exemplo com progresso automático
            const sampleSubtasks = {};
            sampleTasks.forEach((task, index) => {
                if (task.id === now + 1) {
                    sampleSubtasks[task.id] = [
                        { id: Date.now() + index + 1, description: "Criar layout do banner", completed: true },
                        { id: Date.now() + index + 2, description: "Inserir logos institucionais", completed: true },
                        { id: Date.now() + index + 3, description: "Revisar informações", completed: false },
                        { id: Date.now() + index + 4, description: "Aprovar comando", completed: false },
                        { id: Date.now() + index + 5, description: "Enviar para impressão", completed: false }
                    ];
                } else if (task.id === now + 2) {
                    sampleSubtasks[task.id] = [
                        { id: Date.now() + index + 1, description: "Preparar apresentação", completed: false },
                        { id: Date.now() + index + 2, description: "Confirmar presenças", completed: false },
                        { id: Date.now() + index + 3, description: "Organizar documentos", completed: false }
                    ];
                } else {
                    sampleSubtasks[task.id] = [
                        { id: Date.now() + index + 1, description: "Montar estrutura", completed: true },
                        { id: Date.now() + index + 2, description: "Coordenar equipas médicas", completed: true },
                        { id: Date.now() + index + 3, description: "Atender população", completed: true }
                    ];
                }
            });
            subtasks = sampleSubtasks;
            saveAllData();
            
            // Comentários de exemplo
            const sampleComments = [
                {
                    id: Date.now() + 1,
                    missionId: sampleTasks[0].id,
                    author: currentUser?.fullName || "Sistema",
                    rank: currentUser?.rank || "Sistema",
                    content: "Bem-vindo ao Sistema de Missões das Forças Armadas de Cabo Verde.",
                    timestamp: new Date().toISOString(),
                    createdBy: currentUserId
                }
            ];
            
            comments = sampleComments;
            saveAllData();
            
            // Atualizar progresso das missões baseado nas subtarefas
            updateAllMissionsProgress();
            
            addNotification("📋 Dados iniciais carregados com sucesso!");
        }
        
        // ============================================
        // PROGRESSO AUTOMÁTICO - CORAÇÃO DO SISTEMA
        // ============================================
        function updateMissionProgress(missionId) {
            const missionSubtasks = subtasks[missionId] || [];
            
            if (missionSubtasks.length > 0) {
                const completedCount = missionSubtasks.filter(s => s.completed).length;
                const progress = Math.round((completedCount / missionSubtasks.length) * 100);
                
                const missionIndex = tasks.findIndex(t => t.id == missionId);
                if (missionIndex !== -1) {
                    // Atualizar progresso
                    tasks[missionIndex].progress = progress;
                    
                    // Atualizar status automaticamente baseado no progresso
                    if (progress === 100) {
                        tasks[missionIndex].status = 'completed';
                    } else if (progress > 0) {
                        tasks[missionIndex].status = 'in-progress';
                    } else {
                        tasks[missionIndex].status = 'not-started';
                    }
                    
                    tasks[missionIndex].updatedAt = new Date().toISOString();
                    
                    saveAllData();
                    
                    // Notificação quando missão for concluída
                    if (progress === 100 && tasks[missionIndex].status === 'completed') {
                        addNotification(`✅ Missão "${tasks[missionIndex].title}" foi concluída com sucesso!`);
                    }
                }
            }
        }
        
        function updateAllMissionsProgress() {
            Object.keys(subtasks).forEach(missionId => {
                updateMissionProgress(missionId);
            });
        }
        
        // ============================================
        // SUBTAREFAS
        // ============================================
        function addSubtaskField(description = '', completed = false) {
            const subtasksList = document.getElementById('subtasksList');
            const subtaskId = 'subtask_' + subtaskCounter++;
            
            const div = document.createElement('div');
            div.className = 'subtask-item';
            div.id = subtaskId;
            div.innerHTML = `
                <input type="checkbox" class="subtask-checkbox" ${completed ? 'checked' : ''}>
                <input type="text" class="subtask-input" placeholder="Descrição da subtarefa" value="${description}">
                <button type="button" class="btn btn-outline" style="padding: 5px 10px;" onclick="removeSubtaskField('${subtaskId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            subtasksList.appendChild(div);
        }
        
        function removeSubtaskField(subtaskId) {
            document.getElementById(subtaskId)?.remove();
        }
        
        function toggleSubtask(missionId, subtaskId, completed) {
            const missionSubtasks = subtasks[missionId];
            if (missionSubtasks) {
                const subtask = missionSubtasks.find(s => s.id == subtaskId);
                if (subtask) {
                    subtask.completed = completed;
                    saveAllData();
                    
                    // PROGRESSO AUTOMÁTICO - Atualizar missão
                    updateMissionProgress(missionId);
                    
                    // Atualizar UI
                    loadKanbanBoard();
                    updateDashboardStats();
                }
            }
        }
        
        // ============================================
        // SAVE MISSION
        // ============================================
        function saveMission(event) {
            event.preventDefault();
            
            const taskId = editingTaskId || Date.now();
            
            const taskData = {
                id: taskId,
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                priority: document.getElementById('taskPriority').value,
                deadline: document.getElementById('taskDeadline').value,
                responsible: document.getElementById('taskResponsible').value,
                status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value),
                updatedAt: new Date().toISOString(),
                createdBy: currentUser.userId
            };
            
            // Coletar subtarefas do formulário
            const subtaskElements = document.querySelectorAll('#subtasksList .subtask-item');
            const missionSubtasks = [];
            
            subtaskElements.forEach((el, index) => {
                const checkbox = el.querySelector('.subtask-checkbox');
                const input = el.querySelector('.subtask-input');
                if (input.value.trim()) {
                    missionSubtasks.push({
                        id: Date.now() + index,
                        description: input.value.trim(),
                        completed: checkbox.checked
                    });
                }
            });
            
            if (!editingTaskId) {
                // Nova missão
                taskData.createdAt = new Date().toISOString();
                tasks.push(taskData);
                
                // Salvar subtarefas
                subtasks[taskId] = missionSubtasks;
                
                addNotification(`📋 Nova missão criada: ${taskData.title}`);
            } else {
                // Atualizar missão existente
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex !== -1) {
                    taskData.createdAt = tasks[taskIndex].createdAt;
                    tasks[taskIndex] = taskData;
                    subtasks[editingTaskId] = missionSubtasks;
                    addNotification(`✏️ Missão atualizada: ${taskData.title}`);
                }
            }
            
            // Calcular progresso automático
            if (missionSubtasks.length > 0) {
                const completed = missionSubtasks.filter(s => s.completed).length;
                taskData.progress = Math.round((completed / missionSubtasks.length) * 100);
                taskData.status = taskData.progress === 100 ? 'completed' : 
                                taskData.progress > 0 ? 'in-progress' : 'not-started';
            }
            
            saveAllData();
            closeModal();
            
            // Atualizar todas as views
            updateUI();
            loadKanbanBoard();
            generateCalendar(currentMonth, currentYear);
            updateReportsStats();
        }
        
        // ============================================
        // UPDATE UI
        // ============================================
        function updateUI() {
            updateDashboardStats();
            loadRecentTasks();
            updateProjectSelects();
            checkDueDates();
            
            // Atualizar contador de backup
            const backupTasksCount = document.getElementById('backupTasksCount');
            if (backupTasksCount) backupTasksCount.textContent = tasks.length;
            
            if (dbTasksCount) dbTasksCount.textContent = tasks.length;
            if (dbIdDisplay && currentUser) dbIdDisplay.textContent = currentUser.userId;
            if (dbUserDisplay && currentUser) dbUserDisplay.textContent = currentUser.fullName;
        }
        
        function updateDashboardStats() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const inProgressTasks = tasks.filter(t => t.status === 'in-progress').length;
            const pendingTasks = tasks.filter(t => t.status === 'not-started').length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            
            // Progresso geral
            const totalProgress = tasks.reduce((acc, t) => acc + (t.progress || 0), 0);
            const avgProgress = tasks.length ? Math.round(totalProgress / tasks.length) : 0;
            document.getElementById('overallProgress').style.width = avgProgress + '%';
            document.getElementById('progressPercentage').textContent = avgProgress + '%';
            
            // Meta mensal
            const currentMonth = new Date().getMonth();
            const monthlyTasks = tasks.filter(t => {
                const taskDate = new Date(t.deadline);
                return taskDate.getMonth() === currentMonth;
            });
            const completedMonthly = monthlyTasks.filter(t => t.status === 'completed').length;
            document.getElementById('monthlyGoal').textContent = `${completedMonthly}/${monthlyTasks.length}`;
            
            renderChart();
        }
        
        function renderChart() {
            const ctx = document.getElementById('productivityChart')?.getContext('2d');
            if (!ctx) return;
            
            if (chartInstance) chartInstance.destroy();
            
            const statusCount = {
                pendente: tasks.filter(t => t.status === 'not-started').length,
                progresso: tasks.filter(t => t.status === 'in-progress').length,
                concluido: tasks.filter(t => t.status === 'completed').length
            };
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendentes', 'Em Progresso', 'Concluídas'],
                    datasets: [{
                        data: [statusCount.pendente, statusCount.progresso, statusCount.concluido],
                        backgroundColor: ['#9ca3af', '#f59e0b', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // ============================================
        // LOAD RECENT TASKS
        // ============================================
        function loadRecentTasks() {
            const recentTasksList = document.getElementById('recentTasksList');
            if (!recentTasksList) return;
            
            recentTasksList.innerHTML = '';
            
            const sortedTasks = [...tasks].sort((a, b) => 
                new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt)
            );
            
            const recentTasks = sortedTasks.slice(0, 5);
            
            recentTasks.forEach(task => {
                recentTasksList.appendChild(createTaskElement(task));
            });
            
            if (recentTasks.length === 0) {
                recentTasksList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Nenhuma missão cadastrada. Clique em "Nova Missão" para começar.</p>';
            }
        }
        
        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item';
            taskElement.dataset.id = task.id;
            
            const priorityClass = `priority-${task.priority}`;
            const priorityText = {
                'low': 'Baixa',
                'medium': 'Média', 
                'high': 'Alta',
                'urgent': 'Urgente'
            }[task.priority] || 'Média';
            
            const statusClass = `status-${task.status}`;
            const statusText = {
                'not-started': 'Não Iniciada',
                'in-progress': 'Em Andamento',
                'completed': 'Concluída'
            }[task.status] || 'Não Iniciada';
            
            const deadlineDate = new Date(task.deadline);
            const formattedDate = deadlineDate.toLocaleDateString('pt-CV');
            const isLate = task.status !== 'completed' && deadlineDate < new Date();
            
            // Calcular progresso das subtarefas
            const taskSubtasks = subtasks[task.id] || [];
            const completedSubtasks = taskSubtasks.filter(s => s.completed).length;
            const progress = taskSubtasks.length > 0 ? Math.round((completedSubtasks / taskSubtasks.length) * 100) : (task.progress || 0);
            
            taskElement.innerHTML = `
                <div class="task-info">
                    <h4>${task.title}</h4>
                    <div class="task-meta">
                        <span><i class="far fa-calendar"></i> Prazo: ${formattedDate} ${isLate ? '<span style="color: var(--danger);">(Atrasada)</span>' : ''}</span>
                        <span><i class="fas fa-user"></i> ${task.responsible}</span>
                        <span class="task-priority ${priorityClass}">${priorityText}</span>
                        <span class="task-status ${statusClass}">${statusText}</span>
                        <span><i class="fas fa-chart-line"></i> ${progress}%</span>
                        <span><i class="fas fa-tasks"></i> ${completedSubtasks}/${taskSubtasks.length}</span>
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn" onclick="openMissionModal(${task.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return taskElement;
        }
        
        // ============================================
        // KANBAN BOARD
        // ============================================
        function loadKanbanBoard() {
            const statusColumns = {
                'not-started': document.querySelector('[data-status="not-started"]'),
                'in-progress': document.querySelector('[data-status="in-progress"]'),
                'completed': document.querySelector('[data-status="completed"]')
            };
            
            Object.values(statusColumns).forEach(column => {
                if (column) column.innerHTML = '';
            });
            
            let filteredTasks = [...tasks];
            
            // Aplicar filtros
            const filterPriority = document.getElementById('filterPriority')?.value;
            const filterStatus = document.getElementById('filterStatus')?.value;
            const filterDate = document.getElementById('filterDate')?.value;
            
            if (filterPriority) filteredTasks = filteredTasks.filter(t => t.priority === filterPriority);
            if (filterStatus) filteredTasks = filteredTasks.filter(t => t.status === filterStatus);
            if (filterDate) filteredTasks = filteredTasks.filter(t => t.deadline === filterDate);
            
            filteredTasks.forEach(task => {
                const column = statusColumns[task.status];
                if (column) {
                    column.appendChild(createKanbanTaskElement(task));
                }
            });
            
            makeTasksDraggable();
        }
        
        function createKanbanTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'kanban-task';
            taskElement.dataset.id = task.id;
            taskElement.draggable = true;
            
            const priorityClass = `priority-${task.priority}`;
            const priorityText = {
                'low': 'Baixa',
                'medium': 'Média', 
                'high': 'Alta',
                'urgent': 'Urgente'
            }[task.priority] || 'Média';
            
            const deadlineDate = new Date(task.deadline);
            const formattedDate = deadlineDate.toLocaleDateString('pt-CV');
            const isLate = task.status !== 'completed' && deadlineDate < new Date();
            
            // Calcular progresso das subtarefas - PROGRESSO AUTOMÁTICO
            const taskSubtasks = subtasks[task.id] || [];
            const completedSubtasks = taskSubtasks.filter(s => s.completed).length;
            const progress = taskSubtasks.length > 0 ? Math.round((completedSubtasks / taskSubtasks.length) * 100) : (task.progress || 0);
            
            taskElement.innerHTML = `
                <h4>${task.title}</h4>
                <p style="font-size: 0.9rem; margin-bottom: 10px; color: var(--gray);">${task.description?.substring(0, 80)}${task.description?.length > 80 ? '...' : ''}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="task-priority ${priorityClass}" style="font-size: 0.75rem;">${priorityText}</span>
                    <span style="font-size: 0.8rem; ${isLate ? 'color: var(--danger);' : ''}">
                        <i class="far fa-calendar"></i> ${formattedDate}
                        ${isLate ? '<i class="fas fa-exclamation-circle"></i>' : ''}
                    </span>
                </div>
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.8rem;">Progresso:</span>
                        <span style="font-size: 0.8rem; font-weight: 600;">${progress}%</span>
                    </div>
                    <div class="progress-bar-container" style="height: 6px;">
                        <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                    </div>
                </div>
                <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                    <span style="font-size: 0.8rem;"><i class="fas fa-user"></i> ${task.responsible}</span>
                    <span style="font-size: 0.8rem;"><i class="fas fa-tasks"></i> ${completedSubtasks}/${taskSubtasks.length}</span>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                    ${taskSubtasks.slice(0, 2).map(sub => `
                        <span style="font-size: 0.7rem; padding: 2px 6px; background: ${sub.completed ? 'var(--success)' : 'var(--gray)'}; color: white; border-radius: 12px;">
                            ${sub.completed ? '✓' : '○'} ${sub.description.substring(0, 15)}${sub.description.length > 15 ? '...' : ''}
                        </span>
                    `).join('')}
                    ${taskSubtasks.length > 2 ? `<span style="font-size: 0.7rem; color: var(--gray);">+${taskSubtasks.length - 2}</span>` : ''}
                </div>
            `;
            
            return taskElement;
        }
        
        function makeTasksDraggable() {
            const kanbanTasks = document.querySelectorAll('.kanban-task');
            const kanbanColumns = document.querySelectorAll('.kanban-column-content');
            
            kanbanTasks.forEach(task => {
                task.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.id);
                    this.style.opacity = '0.5';
                });
                
                task.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
            });
            
            kanbanColumns.forEach(column => {
                column.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = 'rgba(30, 74, 143, 0.1)';
                });
                
                column.addEventListener('dragleave', function() {
                    this.style.backgroundColor = '';
                });
                
                column.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '';
                    
                    const taskId = parseInt(e.dataTransfer.getData('text/plain'));
                    const newStatus = this.dataset.status;
                    
                    updateTaskStatus(taskId, newStatus);
                });
            });
        }
        
        function updateTaskStatus(taskId, newStatus) {
            const taskIndex = tasks.findIndex(t => t.id == taskId);
            
            if (taskIndex !== -1) {
                const oldStatus = tasks[taskIndex].status;
                tasks[taskIndex].status = newStatus;
                
                // Se mover para concluído, marcar todas subtarefas como concluídas
                if (newStatus === 'completed' && subtasks[taskId]) {
                    subtasks[taskId].forEach(sub => sub.completed = true);
                    tasks[taskIndex].progress = 100;
                    saveAllData();
                }
                
                tasks[taskIndex].updatedAt = new Date().toISOString();
                
                saveAllData();
                loadKanbanBoard();
                updateDashboardStats();
                
                addNotification(`🔄 Missão "${tasks[taskIndex].title}" movida de ${getStatusText(oldStatus)} para ${getStatusText(newStatus)}`);
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'not-started': 'Não Iniciada',
                'in-progress': 'Em Andamento',
                'completed': 'Concluída'
            };
            return statusMap[status] || status;
        }
        
        // ============================================
        // FILTERS
        // ============================================
        function applyFilters() {
            loadKanbanBoard();
        }
        
        function clearFilters() {
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDate').value = '';
            loadKanbanBoard();
        }
        
        // ============================================
        // COMMENTS
        // ============================================
        function loadComments() {
            if (!commentsList) return;
            
            commentsList.innerHTML = '';
            
            const sortedComments = [...comments].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedComments.forEach(comment => {
                commentsList.appendChild(createCommentElement(comment));
            });
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Nenhum comentário ainda. Seja o primeiro a comentar!</p>';
            }
            
            commentsList.scrollTop = commentsList.scrollHeight;
        }
        
        function createCommentElement(comment) {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            
            const date = new Date(comment.timestamp);
            const formattedDate = formatDate(date);
            
            let missionInfo = '';
            if (comment.missionId) {
                const mission = tasks.find(t => t.id == comment.missionId);
                if (mission) {
                    missionInfo = `<span style="font-size: 0.8rem; background: var(--primary-light); color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">${mission.title}</span>`;
                }
            }
            
            commentElement.innerHTML = `
                <div class="comment-header">
                    <div class="comment-author">
                        <i class="fas fa-user-circle"></i> ${comment.author} (${comment.rank})
                        ${missionInfo}
                    </div>
                    <div class="comment-time">
                        <i class="far fa-clock"></i> ${formattedDate}
                    </div>
                </div>
                <div class="comment-content">${comment.content}</div>
            `;
            
            return commentElement;
        }
        
        function addComment(content, missionId) {
            if (!currentUser) return;
            
            const comment = {
                id: Date.now(),
                missionId: missionId,
                author: currentUser.fullName,
                rank: currentUser.rank,
                content: content,
                timestamp: new Date().toISOString(),
                createdBy: currentUserId
            };
            
            comments.unshift(comment);
            saveAllData();
            loadComments();
            
            if (missionId) {
                const mission = tasks.find(t => t.id == missionId);
                if (mission) {
                    addNotification(`💬 ${currentUser.fullName} comentou em "${mission.title}"`);
                }
            } else {
                addNotification(`💬 ${currentUser.fullName} deixou um comentário`);
            }
        }
        
        // ============================================
        // NOTIFICATIONS
        // ============================================
        function addNotification(message, type = 'info') {
            const notification = {
                id: Date.now(),
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            saveAllData();
            
            if (Notification.permission === 'granted' && document.hidden) {
                new Notification('FACV - Sistema de Missões', {
                    body: message,
                    icon: 'img/Brasão das FA 4-4.png'
                });
            }
            
            updateNotificationBadge();
            loadNotificationsPanel();
        }
        
        function updateNotificationBadge() {
            const unread = notifications.filter(n => !n.read).length;
            if (notificationCount) {
                notificationCount.textContent = unread;
                notificationCount.style.display = unread > 0 ? 'flex' : 'none';
            }
            
            const dashboardNotification = document.getElementById('dashboardNotification');
            if (dashboardNotification) {
                dashboardNotification.textContent = unread;
                dashboardNotification.style.display = unread > 0 ? 'flex' : 'none';
            }
        }
        
        function toggleNotificationPanel() {
            if (notificationPanel.style.display === 'block') {
                notificationPanel.style.display = 'none';
            } else {
                loadNotificationsPanel();
                notificationPanel.style.display = 'block';
            }
        }
        
        function loadNotificationsPanel() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600;">${n.message}</span>
                        <span style="font-size: 0.7rem; color: var(--gray);">${formatTimeAgo(n.timestamp)}</span>
                    </div>
                </div>
            `).join('');
            
            if (notifications.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">Nenhuma notificação</div>';
            }
        }
        
        function markNotificationRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveAllData();
                updateNotificationBadge();
                loadNotificationsPanel();
            }
        }
        
        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            saveAllData();
            updateNotificationBadge();
            loadNotificationsPanel();
            addNotification('📬 Todas as notificações marcadas como lidas');
        }
        
        function checkDueDates() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            
            tasks.forEach(task => {
                if (task.status === 'completed') return;
                
                if (task.deadline === today) {
                    addNotification(`📅 HOJE: Missão "${task.title}" vence hoje!`, 'warning');
                } else if (task.deadline === tomorrow) {
                    addNotification(`⏰ AMANHÃ: Missão "${task.title}" vence amanhã`, 'info');
                } else if (task.deadline < today) {
                    addNotification(`⚠️ ATRASADA: Missão "${task.title}" está ${Math.round((new Date() - new Date(task.deadline)) / 86400000)} dias atrasada!`, 'danger');
                }
                
                if (task.priority === 'urgent' && task.status !== 'completed') {
                    addNotification(`🔴 URGENTE: Missão "${task.title}" requer atenção imediata!`, 'danger');
                }
            });
        }
        
        // ============================================
        // CALENDAR
        // ============================================
        function generateCalendar(month, year) {
            const monthNames = [
                "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();
            
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();
            
            calendarDays.innerHTML = '';
            
            // Dias do mês anterior
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayIndex; i > 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${prevMonthLastDay - i + 1}</div>`;
                calendarDays.appendChild(dayElement);
            }
            
            // Dias do mês atual
            for (let day = 1; day <= totalDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (day === todayDate && month === todayMonth && year === todayYear) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="calendar-events" id="events-${year}-${month + 1}-${day}"></div>
                `;
                
                calendarDays.appendChild(dayElement);
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                addTasksToCalendar(dateStr, dayElement);
            }
            
            // Dias do mês seguinte
            const totalCells = 42;
            const nextMonthDays = totalCells - (firstDayIndex + totalDays);
            for (let day = 1; day <= nextMonthDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                calendarDays.appendChild(dayElement);
            }
        }
        
        function addTasksToCalendar(dateStr, dayElement) {
            const tasksForDate = tasks.filter(task => task.deadline === dateStr);
            
            if (tasksForDate.length > 0) {
                const eventsContainer = dayElement.querySelector('.calendar-events');
                
                tasksForDate.forEach(task => {
                    const eventElement = document.createElement('div');
                    const priorityClass = task.priority === 'urgent' || task.priority === 'high' ? 'event-urgent' : 
                                       task.priority === 'medium' ? 'event-medium' : 'event-low';
                    
                    eventElement.className = `calendar-event ${priorityClass}`;
                    eventElement.title = `${task.title} - ${task.responsible} - ${task.progress}%`;
                    eventElement.textContent = task.title.substring(0, 12) + (task.title.length > 12 ? '...' : '');
                    
                    if (task.status === 'completed') {
                        eventElement.style.opacity = '0.7';
                        eventElement.style.textDecoration = 'line-through';
                    }
                    
                    eventsContainer.appendChild(eventElement);
                });
            }
        }
        
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentMonth, currentYear);
        }
        
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        }
        
        // ============================================
        // REPORTS
        // ============================================
        function updateReportsStats() {
            // Progress by responsible
            const progressByResponsible = document.getElementById('progressByResponsible');
            if (progressByResponsible) {
                const responsibles = [...new Set(tasks.map(t => t.responsible))];
                
                let progressHTML = '';
                responsibles.forEach(responsible => {
                    const responsibleTasks = tasks.filter(t => t.responsible === responsible);
                    const totalProgress = responsibleTasks.reduce((sum, task) => sum + (task.progress || 0), 0);
                    const avgProgress = responsibleTasks.length > 0 ? Math.round(totalProgress / responsibleTasks.length) : 0;
                    
                    progressHTML += `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">${responsible}</span>
                                <span>${avgProgress}%</span>
                            </div>
                            <div class="progress-bar-container" style="height: 6px;">
                                <div class="progress-bar-fill" style="width: ${avgProgress}%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem;">
                                <span>${responsibleTasks.filter(t => t.status === 'completed').length} concluídas</span>
                                <span>${responsibleTasks.length} total</span>
                            </div>
                        </div>
                    `;
                });
                
                progressByResponsible.innerHTML = progressHTML || '<p style="color: var(--gray); text-align: center;">Nenhum responsável encontrado</p>';
            }
            
            // Tasks by priority
            const tasksByPriority = document.getElementById('tasksByPriority');
            if (tasksByPriority) {
                const priorityCounts = {
                    low: tasks.filter(t => t.priority === 'low').length,
                    medium: tasks.filter(t => t.priority === 'medium').length,
                    high: tasks.filter(t => t.priority === 'high').length,
                    urgent: tasks.filter(t => t.priority === 'urgent').length
                };
                
                let priorityHTML = '';
                for (const [priority, count] of Object.entries(priorityCounts)) {
                    const priorityText = {
                        'low': 'Baixa',
                        'medium': 'Média', 
                        'high': 'Alta',
                        'urgent': 'Urgente'
                    }[priority];
                    
                    const percentage = tasks.length > 0 ? Math.round((count / tasks.length) * 100) : 0;
                    
                    priorityHTML += `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">${priorityText}</span>
                                <span>${count} missões (${percentage}%)</span>
                            </div>
                            <div class="progress-bar-container" style="height: 6px;">
                                <div class="progress-bar-fill" style="width: ${percentage}%; background-color: ${
                                    priority === 'urgent' ? 'var(--danger)' : 
                                    priority === 'high' ? '#f59e0b' : 
                                    priority === 'medium' ? 'var(--warning)' : 'var(--success)'
                                };"></div>
                            </div>
                        </div>
                    `;
                }
                
                tasksByPriority.innerHTML = priorityHTML || '<p style="color: var(--gray); text-align: center;">Nenhuma missão encontrada</p>';
            }
        }
        
        function updateProjectSelects() {
            const selects = ['reportProject'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Todos os Projetos</option>';
                    
                    const projects = [...new Set(tasks.map(t => t.responsible))];
                    projects.forEach(project => {
                        if (project) {
                            select.innerHTML += `<option value="${project}">${project}</option>`;
                        }
                    });
                }
            });
        }
        
        // ============================================
        // PDF GENERATION
        // ============================================
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.setTextColor(10, 46, 92);
            doc.text('Forças Armadas de Cabo Verde', 20, 20);
            
            doc.setFontSize(16);
            doc.text('Relatório de Missões', 20, 35);
            
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-CV')}`, 20, 45);
            doc.text(`Usuário: ${currentUser?.fullName || 'Sistema'} (${currentUser?.rank || ''})`, 20, 52);
            
            const project = document.getElementById('reportProject')?.value;
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;
            
            let filteredTasks = [...tasks];
            
            if (project) filteredTasks = filteredTasks.filter(t => t.responsible === project);
            if (startDate) filteredTasks = filteredTasks.filter(t => t.deadline >= startDate);
            if (endDate) filteredTasks = filteredTasks.filter(t => t.deadline <= endDate);
            
            doc.setFontSize(14);
            doc.setTextColor(10, 46, 92);
            doc.text('Resumo', 20, 70);
            
            doc.setFontSize(11);
            doc.setTextColor(0);
            doc.text(`Total de Missões: ${filteredTasks.length}`, 25, 82);
            doc.text(`Concluídas: ${filteredTasks.filter(t => t.status === 'completed').length}`, 25, 92);
            doc.text(`Em Andamento: ${filteredTasks.filter(t => t.status === 'in-progress').length}`, 25, 102);
            doc.text(`Pendentes: ${filteredTasks.filter(t => t.status === 'not-started').length}`, 25, 112);
            
            const tableData = filteredTasks.map(t => [
                t.title,
                t.responsible || '-',
                t.priority === 'urgent' ? '🔴' : t.priority === 'high' ? '🟠' : '🟡',
                `${t.progress || 0}%`,
                t.status === 'completed' ? '✅' : t.status === 'in-progress' ? '🔄' : '⏳',
                t.deadline || '-'
            ]);
            
            doc.autoTable({
                head: [['Missão', 'Responsável', 'Prioridade', 'Progresso', 'Status', 'Prazo']],
                body: tableData,
                startY: 125,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [10, 46, 92] }
            });
            
            doc.save(`relatorio-missoes-${new Date().toISOString().split('T')[0]}.pdf`);
            addNotification('📄 Relatório PDF gerado com sucesso');
        }
        
        // ============================================
        // EXPORT TO EXCEL
        // ============================================
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            const missionData = [
                ['ID', 'Missão', 'Descrição', 'Prioridade', 'Status', 'Progresso', 'Responsável', 'Data Início', 'Data Fim', 'Data Atualização']
            ];
            
            tasks.forEach(m => {
                missionData.push([
                    m.id,
                    m.title,
                    m.description,
                    m.priority,
                    m.status,
                    `${m.progress || 0}%`,
                    m.responsible || '-',
                    m.createdAt?.split('T')[0] || '-',
                    m.deadline || '-',
                    m.updatedAt?.split('T')[0] || '-'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(missionData);
            XLSX.utils.book_append_sheet(wb, ws, 'Missões');
            
            const subtaskData = [
                ['ID Missão', 'Missão', 'Subtarefa', 'Status', 'Descrição']
            ];
            
            Object.entries(subtasks).forEach(([missionId, taskSubtasks]) => {
                const mission = tasks.find(m => m.id == missionId);
                taskSubtasks.forEach(sub => {
                    subtaskData.push([
                        missionId,
                        mission?.title || '-',
                        sub.id,
                        sub.completed ? 'Concluída' : 'Pendente',
                        sub.description
                    ]);
                });
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(subtaskData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Subtarefas');
            
            XLSX.writeFile(wb, `missoes-facv-${new Date().toISOString().split('T')[0]}.xlsx`);
            addNotification('📊 Relatório Excel exportado com sucesso');
        }
        
        // ============================================
        // BACKUP
        // ============================================
        function manualBackup() {
            const userDb = new UserDatabase(currentUserId);
            const backup = userDb.getAllData();
            
            localStorage.setItem('facv_last_backup', JSON.stringify({
                timestamp: new Date().toISOString(),
                count: tasks.length
            }));
            
            const lastBackup = document.getElementById('lastBackup');
            if (lastBackup) lastBackup.innerHTML = new Date().toLocaleString('pt-CV');
            
            const backupTasksCount = document.getElementById('backupTasksCount');
            if (backupTasksCount) backupTasksCount.textContent = tasks.length;
            
            addNotification('💾 Backup realizado com sucesso');
        }
        
        // Backup automático a cada 30 minutos
        setInterval(() => {
            if (currentUser) {
                manualBackup();
            }
        }, 30 * 60 * 1000);
        
        // ============================================
        // EXPORT USER DATA
        // ============================================
        function exportUserData() {
            if (!currentUserId) return;
            
            const userDb = new UserDatabase(currentUserId);
            const userData = userDb.getAllData();
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileName = `facv_backup_${currentUserId}_${new Date().toISOString().split('T')[0]}.json`;
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', exportFileName);
            link.click();
            
            addNotification(`📦 Dados exportados: ${exportFileName}`);
        }
        
        // ============================================
        // DELETE TASK
        // ============================================
        function deleteTask(taskId) {
            showConfirmDialog(
                'Confirmar Exclusão',
                'Tem certeza que deseja excluir esta missão permanentemente?',
                function() {
                    const taskIndex = tasks.findIndex(t => t.id == taskId);
                    
                    if (taskIndex !== -1) {
                        const taskTitle = tasks[taskIndex].title;
                        tasks.splice(taskIndex, 1);
                        delete subtasks[taskId];
                        
                        saveAllData();
                        
                        updateUI();
                        loadKanbanBoard();
                        generateCalendar(currentMonth, currentYear);
                        updateReportsStats();
                        
                        addNotification(`🗑️ Missão excluída: ${taskTitle}`);
                    }
                }
            );
        }
        
        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openMissionModal(missionId = null) {
            editingTaskId = missionId;
            
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) modalTitle.textContent = missionId ? 'Editar Missão' : 'Nova Missão/Tarefa';
            
            const taskForm = document.getElementById('taskForm');
            if (taskForm) taskForm.reset();
            
            const progressSlider = document.getElementById('taskProgress');
            const progressValue = document.getElementById('progressValue');
            if (progressSlider && progressValue) {
                progressSlider.value = 0;
                progressValue.textContent = '0%';
            }
            
            const subtasksList = document.getElementById('subtasksList');
            if (subtasksList) subtasksList.innerHTML = '';
            subtaskCounter = 0;
            
            // Adicionar campo de subtarefa padrão
            addSubtaskField();
            
            if (missionId) {
                const task = tasks.find(t => t.id == missionId);
                if (task) {
                    document.getElementById('taskTitle').value = task.title || '';
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    document.getElementById('taskDeadline').value = task.deadline || getDateString(1);
                    document.getElementById('taskResponsible').value = task.responsible || '';
                    document.getElementById('taskStatus').value = task.status || 'not-started';
                    document.getElementById('taskProgress').value = task.progress || 0;
                    if (progressValue) progressValue.textContent = (task.progress || 0) + '%';
                    
                    // Carregar subtarefas existentes
                    if (subtasks[missionId] && subtasksList) {
                        subtasksList.innerHTML = '';
                        subtasks[missionId].forEach(sub => {
                            addSubtaskField(sub.description, sub.completed);
                        });
                    }
                }
            } else {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const deadlineInput = document.getElementById('taskDeadline');
                if (deadlineInput) deadlineInput.valueAsDate = tomorrow;
            }
            
            const modal = document.getElementById('taskFormModal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeModal() {
            const modal = document.getElementById('taskFormModal');
            if (modal) modal.style.display = 'none';
            editingTaskId = null;
        }
        
        function updateProgressValue(value) {
            const progressValue = document.getElementById('progressValue');
            if (progressValue) progressValue.textContent = value + '%';
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getDateString(daysFromNow) {
            const date = new Date();
            date.setDate(date.getDate() + daysFromNow);
            return date.toISOString().split('T')[0];
        }
        
        function showApp() {
            loginPage.style.display = 'none';
            appContainer.style.display = 'block';
            
            if (loggedUserName) loggedUserName.textContent = currentUser.fullName;
            if (loggedUserRank) loggedUserRank.textContent = currentUser.rank;
            if (loggedUserId) loggedUserId.textContent = `ID: ${currentUser.userId}`;
            
            if (dbIdDisplay) dbIdDisplay.textContent = currentUser.userId;
            if (dbUserDisplay) dbUserDisplay.textContent = currentUser.fullName;
            if (dbTasksCount) dbTasksCount.textContent = tasks.length;
            
            updateDashboardStats();
            loadRecentTasks();
            loadKanbanBoard();
            loadComments();
            generateCalendar(currentMonth, currentYear);
            updateNotificationBadge();
        }
        
        // ============================================
        // DARK MODE
        // ============================================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('facv_dark_mode', isDark);
            
            const icon = darkModeToggle.querySelector('i');
            if (icon) {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            addNotification(isDark ? '🌙 Modo escuro ativado' : '☀️ Modo claro ativado');
            renderChart();
        }
        
        // ============================================
        // FORMATTING UTILITIES
        // ============================================
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSeconds < 60) return 'agora';
            if (diffMinutes < 60) return `${diffMinutes}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays === 1) return 'ontem';
            if (diffDays < 7) return `${diffDays}d`;
            return formatDate(date);
        }
    </script>
</body>
</html>